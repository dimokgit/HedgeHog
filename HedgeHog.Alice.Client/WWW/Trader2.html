<!DOCTYPE html>
<html>
<head lang="en">
  <title>SignalR Chart</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
  <script src='d3-knockout/view-models/data-view-model.js' type='text/javascript'></script>
  <script src='d3-knockout/custom-binding-handlers/line-chart-binding.js' type='text/javascript'></script>
  <script type='text/javascript' src='d3-knockout/app.js'></script>
 <style type="text/css">
    body, html {
      padding: 0;
      margin: 0;
    }

    .container {
      background-color: #99CCFF;
      padding: 0;
      margin: 0;
    }

    ul, li {
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>
  <!--<input type="text" id="message" size="5" />
  <input type="button" id="sendmessage" value="Send" />
  <input type="hidden" id="displayname" />-->
  <div class="masthead">
    <nav>
      <ul class="nav nav-tabs">
        <li><input type="button" value="Stop" id="stopTrades" /></li>
        <li><button id="startBuy"><span class="glyphicon glyphicon-circle-arrow-up"></span>Start</button></li>
        <li><button id="startSell"><span class="glyphicon glyphicon-circle-arrow-down"></span>Start</button></li>
        <li><input type="button" value=" Close " id="closeTrades" /></li>
        <li><input type="button" value=" Buy " id="buy" /></li>
        <li><input type="button" value=" Sell " id="sell" /></li>
        <li><button id="buyDown">B<span class="glyphicon glyphicon-save"></span></button></li>
        <li><button id="buyUp">B<span class="glyphicon glyphicon-open"></span></button></li>
        <li><button id="sellDown">S<span class="glyphicon glyphicon-save"></span></button></li>
        <li><button id="sellUp">S<span class="glyphicon glyphicon-open"></span></button></li>
        <li>
          <select id="tradeCounts">
            <option value="0" selected="selected">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
          <input type="button" value="TC" title="Set Trade Count" id="tradeCount" />
        </li>
        <li>
          <select id="plotterNum">
            <option selected="selected" value="">M</option>
            <option value="2">S</option>
          </select>
        </li>
        <li role="presentation" class="dropdown">
          <button class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">...</button>
          <ul class="dropdown-menu" role="menu">
            <li><input type="button" value="Manual" id="manualToggle" /></li>
            <li><button id="toggleStartDate">StartDate</button></li>
            <li><button id="toggleIsActive">Active</button></li>
            <li><button id="flipTradeLevels">Flip</button></li>
            <li><button id="setDefaultTradeLevels">Default</button></li>
            <li><button id="alwaysOn">AlwaysOn</button></li>
            <li><button id="buySellInit">WrapTrade</button></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
    <div class="container container-fluid">
      <input value="" id="rsdMin" style="width:1.5em" />
      <span id="discussion"></span>
    </div>
  <div class="row">
    <div class="col-md-12 bigChart" data-bind='barChart: barChartData'></div>
  </div>
    <img id="plotter" class="img-responsive" />
    <img id="plotter2" class="img-responsive" />
    <script src="Scripts/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <!--<script src="http://ruleover.com:80/signalr/hubs"></script>-->
    <script type="text/javascript">
      var hubUrl = location.protocol + "//" + location.host + "/signalr/hubs";
      //$.getScript(hubUrl, init);
      var host = location.host;
      var pair = "usdjpy";
      function plotterSrc() { return "http://" + host + "/" + pair + $("#plotterNum").val()+ "?" + new Date().getTime(); }
      function init() {
        $('#plotter').attr("src", plotterSrc());
        //Set the hubs URL for the connection
        $.connection.hub.url = "http://" + host + "/signalr";

        // Declare a proxy to reference the hub.
        var chat = $.connection.myHub;

        // Create a function that the hub can call to broadcast messages.
        function addMessage(response) {
          if (!$('#rsdMin').is(":focus")) $('#rsdMin').val(response.rsdMin);
          delete response.rsdMin;
          $('#discussion').html(JSON.stringify(response).substr(1));
          //var name = response.ServerTime, message = response.PriceAvg;
          //// Html encode display name and message.
          //var encodedName = $('<div />').text(name).html();
          //var encodedMsg = $('<div />').text(message).html();
          //// Add the message to the page.
          //$('#discussion').html('<li><strong>' + encodedName
          //    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
          resetPlotter();
        }
        chat.client.addMessage = addMessage;
        chat.client.newInfo = function (info) {
          $('#discussion').append('<li><strong>' + info + '</strong></li>');
        }
        // Get the user name and store it to prepend to messages.
        //$('#displayname').val(prompt('Enter your name:', ''));
        // Set initial focus to message input box.
        $('#message').focus();
        // Start the connection.
        $.connection.hub.start().done(function () {
          $('#sendmessage').click(function () {
            // Call the Send method on the hub.
            chat.server.send(pair, $('#message').val());
            // Clear text box and reset focus for next comment.
            $('#message').val('').focus();
          });
          $('#stopTrades').click(function () {
            chat.server.stopTrades(pair);
            resetPlotter();
          });
          $('#startBuy').click(function () {
            chat.server.startTrades(pair,true);
            resetPlotter();
          });
          $('#startSell').click(function () {
            chat.server.startTrades(pair, false);
            resetPlotter();
          });
          $('#closeTrades').click(function () {
            chat.server.closeTrades(pair);
            resetPlotter();
          });
          $('#tradeCount').click(function () {
            chat.server.setTradeCount(pair, $("#tradeCounts").val());
            resetPlotter();
          });
          function moveTradeLeve(isBuy, pips) {
            chat.server.moveTradeLevel(pair, isBuy, pips);
            resetPlotter();
          }
          $('#buyUp').click(function () {
            moveTradeLeve(true, 1);
          });
          $('#buyDown').click(function () {
            moveTradeLeve(true, -1);
          });
          $('#sellUp').click(function () {
            moveTradeLeve(false, 1);
          });
          $('#sellDown').click(function () {
            moveTradeLeve(false, -1);
          });
          $('#buySellInit').click(function () { invokeByName("wrapTradeInCorridor") });
          $('#manualToggle').click(function () {
            chat.server.manualToggle(pair);
            resetPlotter();
          });
          $('#sell').click(function () { invokeByName("sell"); });
          $('#buy').click(function () { invokeByName("buy"); });
          $('#toggleStartDate').click(function () { invokeByName("toggleStartDate"); });
          $('#toggleIsActive').click(function () { invokeByName("toggleIsActive"); });
          $('#flipTradeLevels').click(function () { invokeByName("flipTradeLevels"); });
          $('#setDefaultTradeLevels').click(function () { invokeByName("setDefaultTradeLevels"); });
          $('#alwaysOn').click(function () { invokeByName("setAlwaysOn"); });
          $('#rsdMin').change(function () {
            chat.server.setRsdTreshold(pair, $('#rsdMin').val());
            resetPlotter();
          });

          function invokeByName(func){
            chat.server[func](pair);
            resetPlotter();
          }
        });
        function resetPlotter() {
          setTimeout(function () {
            $('#plotter').attr("src", plotterSrc());
          }, 1000);

        }
      }
    </script>
</body>
</html>
